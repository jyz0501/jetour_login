name: Jetour Auto Worker

# 触发器：每天UTC时间16点（北京时间0点）和2点（北京时间10点）执行
on:
  schedule:
    - cron: '0 16 * * *'  # UTC 16:00 = 北京时间 00:00
    - cron: '0 2 * * *'   # UTC 02:00 = 北京时间 10:00
  workflow_dispatch:       # 允许手动触发
  push:
    branches: [ main ]     # 推送时也触发，确保Pages及时更新

jobs:
  jetour-auto-worker:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出代码
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史记录，便于Pages部署
      
      # 2. 设置Python环境
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      # 3. 安装依赖
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      # 4. 执行捷途自动工作脚本
      - name: Run Jetour Auto Worker
        env:
          JETOUR_ACCESS_TOKEN: ${{ secrets.JETOUR_ACCESS_TOKEN }}
          JETOUR_TASK_ID: ${{ secrets.JETOUR_TASK_ID }}
        run: |
          python3 jetour_auto_worker.py
      
      # 5. 执行信息提取脚本（生成仪表盘数据）
      - name: Run Jetour Sign Info Extractor
        env:
          ACCESS_TOKEN: ${{ secrets.JETOUR_ACCESS_TOKEN }}
          TASK_ID: ${{ secrets.JETOUR_TASK_ID }}
          CARD_ACCOUNT_ID: ${{ secrets.JETOUR_CARD_ACCOUNT_ID }}
        run: |
          python3 extract_jetour_sign_info.py
      
      # 6. 配置Git用户信息（为Pages部署准备）
      - name: Setup Git User
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
      
      # 7. 部署到GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .                    # 发布整个仓库
          publish_branch: gh-pages          # 部署到gh-pages分支
          force_orphan: true                # 保持分支整洁
          allow_empty_commit: true          # 允许空提交
          # 只包含必要的文件
          include_files: |
            index.html
            sign-data.json
            auto-worker-results.json
            .nojekyll
            assets/
            dist/
          # 排除不需要的文件
          exclude_files: |
            .github/
            *.py
            requirements.txt
            README.md
