name: Jetour Auto Worker

# 触发器：每天UTC时间16点（北京时间0点）和2点（北京时间10点）执行
# 注意：GitHub Actions使用UTC时间，需要转换为北京时间
on:
  schedule:
    # 每天UTC时间16点（北京时间0点）执行
    - cron: '0 16 * * *'
    # 每天UTC时间2点（北京时间10点）执行
    - cron: '0 2 * * *'
  # 允许手动触发
  workflow_dispatch:

# 工作流任务
jobs:
  jetour-auto-worker:
    # 运行环境
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出代码仓库
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # 2. 设置Python环境
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      # 3. 安装依赖
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      # 4. 执行捷途自动工作脚本
      - name: Run Jetour Auto Worker
        env:
          # 从GitHub Secrets中获取敏感信息，直接传递给脚本
          JETOUR_ACCESS_TOKEN: ${{ secrets.JETOUR_ACCESS_TOKEN }}
          JETOUR_TASK_ID: ${{ secrets.JETOUR_TASK_ID }}
        run: |
          # 直接执行自动工作脚本
          python jetour_auto_worker.py
      
      # 5. 执行信息提取脚本（用于更新仪表盘）
      - name: Run Jetour Sign Info Extractor
        env:
          # 从GitHub Secrets中获取敏感信息，直接传递给脚本
          ACCESS_TOKEN: ${{ secrets.JETOUR_ACCESS_TOKEN }}
          TASK_ID: ${{ secrets.JETOUR_TASK_ID }}
          CARD_ACCOUNT_ID: ${{ secrets.JETOUR_CARD_ACCOUNT_ID }}
        run: |
          # 执行信息提取脚本，用于更新仪表盘数据
          python extract_jetour_sign_info.py
      
      # 6. 部署到GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          # 使用GitHub Secrets中的GITHUB_TOKEN
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # 部署目录（当前目录下的所有文件）
          publish_dir: .
          # 部署分支
          publish_branch: gh-pages
          # 允许空提交
          allow_empty_commit: true
          # 清理旧文件
          force_orphan: true
          # 仅部署必要文件
          include_files:
            - index.html
            - sign-data.json
            - auto-worker-results.json
            - .nojekyll
